/**
 * Created by tanhaican on 2016/12/10.
 */
define(function(require,exports,module){var sTpl=require("templates/modules/parent/groupon_item_detail.html"),Constants=require("js/common/Constants"),Utils=require("js/common/Utils"),checkBindStateURL=Constants.APP_SERVER_URL+"order/isBindPhone",sendVariCodeURL=Constants.APP_SERVER_URL+"order/sendPhone",getGrouponDetailURL=(Constants.APP_SERVER_URL+"order/bindPhone",Constants.APP_SERVER_URL+"group/groupDetail"),bookGrouponURL=Constants.APP_SERVER_URL+"order/addGorder";require("js/lib/layer_mobile/layer.js"),require("js/lib/layer_mobile/need/layer.css");var GrouponDetail=Vue.extend({template:sTpl,data:function(){return{ctrl:{showBindPhoneBox:!1,uuid:null,countDown:null},openId:null,groupon:{}}},ready:function(){var vm=this;vm.openId=Utils.Session.get("OPEN_ID"),GrouponService.getGrouponDetail(vm.ctrl.uuid,function(data){vm.groupon=data.obj})},route:{data:function(transition){var vm=this;vm.ctrl.uuid=transition.to.params.uuid}},methods:{call:function(phone){location.href="tel:"+phone},viewMap:function(){var vm=this,groupon=vm.groupon;vm.$router.go({name:"viewOrgLocationMap",params:{lng:groupon.longitude,lat:groupon.latitude,orgName:groupon.orgName}})},bookGroupon:function(){var vm=this;GrouponService.checkBindState(vm.openId,function(isBinded){if(isBinded){var uuid=vm.ctrl.uuid;GrouponService.bookGroupon(uuid,vm.openId,function(data){Utils.Session.put("GROUPON_INFO",data),vm.$router.replace({name:"parentBookSuccess",params:{uuid:uuid}})})}else vm.ctrl.showBindPhoneBox=!0})},sendValidCode:function(){var vm=this,ctrl=vm.ctrl,phoneNo=ctrl.mobilephone;ctrl.validCode="",ctrl.countDown&&ctrl.countDown>0,phoneNo?Utils.isPhone(phoneNo)?GrouponService.sendVariCode(phoneNo,vm.openId,function(){ctrl.countDown=Constants.MSG_COUNT_DOWN;var interval=setInterval(function(){ctrl.countDown-=1,0>=ctrl.countDown&&clearInterval(interval)},1e3)}):layer.open({time:1,skin:"msg",content:"请输入正确的手机号"}):layer.open({time:1,skin:"msg",content:"请输入手机号"})},bindPhone:function(){var vm=this,phoneNo=vm.ctrl.mobilephone,variCode=vm.ctrl.validCode,binder={openid:vm.openId,mobilephone:phoneNo,validCode:variCode};return phoneNo?(variCode||layer.open({time:1,skin:"msg",content:"请输入验证码"}),void GrouponService.bindPhone(binder,function(isBindSuccess){if(isBindSuccess){var uuid=vm.ctrl.uuid;vm.ctrl.showBindPhoneBox=!1,GrouponService.bookGroupon(uuid,vm.openId,function(data){Utils.Session.put("GROUPON_INFO",data),vm.$router.replace({name:"parentBookSuccess",params:{uuid:uuid}})})}})):void layer.open({time:1,skin:"msg",content:"请输入手机号"})}}}),GrouponService={checkBindState:function(openId,callback){var promise=Utils.post(checkBindStateURL,{openid:openId});promise.then(function(response){var retObj=response.body;retObj&&0!==retObj.code?callback&&callback(!0):callback&&callback(!1)},function(response){layer.open({time:1,skin:"msg",content:"请求数据失败"})})},sendVariCode:function(phoneNo,openId,callback){var promise=Utils.post(sendVariCodeURL,{mobilephone:phoneNo});promise.then(function(response){var retObj=response.body;retObj&&1===retObj.code?(layer.open({time:1,skin:"msg",content:"短信已发送"}),callback()):layer.open({time:1,skin:"msg",content:"短信发送失败"})},function(response){layer.open({time:1,skin:"msg",content:"请求数据失败"})})},bindPhone:function(binder,callback){if(binder){if(!binder.openid)return void layer.open({time:1,skin:"msg",content:"获取信息失败，请重新进入"});if(!binder.mobilephone)return void layer.open({time:1,skin:"msg",content:"手机号码不能为空"});if(!binder.validCode)return void layer.open({time:1,skin:"msg",content:"请输入验证码"});var promise=Utils.post(sendVariCodeURL,binder);promise.then(function(response){var retObj=response.body;retObj&&1===retObj.code?(layer.open({time:1,skin:"msg",content:"绑定成功"}),callback&&callback(!0),layer.closeAll()):(layer.open({time:1,skin:"msg",content:"绑定失败"}),callback&&callback(!1))},function(response){layer.open({time:1,skin:"msg",content:"请求数据失败"})})}},getGrouponDetail:function(uuid,callback){var promise=Utils.post(getGrouponDetailURL,{uuid:uuid});promise.then(function(response){var retObj=response.body;retObj&&1===retObj.code?callback&&callback(retObj):layer.open({time:1,skin:"msg",content:retObj.msg})},function(response){layer.open({time:1,skin:"msg",content:"请求数据失败"})})},bookGroupon:function(grouponId,openId,successCallback){var promise=Utils.post(bookGrouponURL,{groupId:grouponId,openid:openId});promise.then(function(response){var retObj=response.body;retObj&&1===retObj.code?(layer.open({time:1,skin:"msg",content:"恭喜您，预约成功"}),successCallback&&successCallback(retObj.obj)):layer.open({time:1,skin:"msg",content:retObj.msg})},function(response){layer.open({time:1,skin:"msg",content:"请求数据失败"})})}};module.exports=GrouponDetail});